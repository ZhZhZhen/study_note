# 执行上下文

### 概述
- 执行上下文分为多个版本，这边介绍es3,es5,es6,es2018,着重描述es3,es6
- 执行上下文在JS预处理阶段（也有称编译阶段）即创建，分为全局执行上下文，函数执行上下文，eval函数执行上下文

#### es3执行上下文
> 包含变量对象VO/作用域Scope/this
- 变量对象VO：全局执行上下文的VO即全局对象global；函数执行上下文的VO由arguments初始化而来，并当作活动对象AO使用。VO记录着声明的变量，声明的函数，函数执行上下文的VO还包含函数的形参，实参。
- 作用域链Scope：用于查找变量标识符，其内容以数组来看等效于AO|VO + [[Scope]]（即函数的执行上下文的变量对象+函数的[[Scope]]属性）
- #函数执行上下文进入执行阶段变量对象VO（初始化阶段）就会转为活动对象AO（执行阶段），所以是同一个东西。

#### es5执行上下文
> 包括词法环境组件/变量环境组件/this

#### es6执行上下文
> 包括词法环境组件（同时用于获取this）/变量环境组件/code evaluation state/Function/Realm/Generator
- 词法环境组件：用于存放let/const/class/function
- 变量环境组件：用于存放var
- code evaluation state：记录执行上下文的执行/挂起/恢复状态
- Function：若当前执行上下文正在执行的是函数对象代码，则指向该函数对象，否则为null
- Realm：包含一系列内置对象，一个全局词法环境和全局对象，加载到全局环境中的代码以及其他的关联状态和资源
- Generator：当前执行上下文的生成器对象

#### es2018执行上下文
> 相较于es6多了ScriptOrModule
- ScriptOrModule：执行的任务是脚本或模块时使用，表示正在执行的代码

#### 词法环境解释：
- 词法环境分为词法环境组件，变量环境组件。组件中都包含一个环境记录，和指向上一个词法环境的outer引用（通过outer来达到作用域链的效果）。执行上下文最初创建的词法环境组件和变量环境组件是相同引用(词法环境组件后续过程可能会临时替换)。词法环境与执行上下文并不是一一对应，遇到with/catch/代码块/命名函数表达式时也会创建词法环境。
- 环境记录分为对象环境记录/声明环境记录/全局环境记录。
    - 对象环境记录主要用于with关键字，global对象，该记录关联了一个对象，并映射了该对象的属性和方法；
    - 声明环境记录类似于key-value结构，包含了标识符的值以及是否可写，常用于函数作用域和块作用域，其中声明环境记录还有两个特殊的表现形式，即函数环境记录（包含了arguments，this绑定）和模块环境记录（包含了模块导入的绑定）；
    - 全局环境记录包含了声明环境记录和对象环境记录，并且全局对象的this绑定指向全局对象（只有函数环境记录和全局环境记录包含this）


